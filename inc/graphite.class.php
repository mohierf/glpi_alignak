<?php

/*
   ------------------------------------------------------------------------
   Glpi-Alignak
   Copyright (c) 2018 by the Alignak Team (http://alignak.net/)
   ------------------------------------------------------------------------

   LICENSE

   This file is part of Glpi-Alignak project.

   Glpi-Alignak is free software: you can redistribute it and/or modify
   it under the terms of the GNU Affero General Public License as published by
   the Free Software Foundation, either version 3 of the License, or
   (at your option) any later version.

   Glpi-Alignak is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
   GNU Affero General Public License for more details.

   You should have received a copy of the GNU Affero General Public License
   along with Glpi-Alignak . If not, see <http://www.gnu.org/licenses/>.

   ------------------------------------------------------------------------

   @package   Alignak
   @author    Frederic Mohier
   @copyright Copyright (c) 2018 Alignak team
   @license   AGPLv3 or (at your option) any later version
              http://www.gnu.org/licenses/agpl-3.0-standalone.html
   @link      http://alignak.net/
   @since     2018

   ------------------------------------------------------------------------
 */

// ----------------------------------------------------------------------
// Original Author of file: Francois Mohier
// Purpose of file:
// ----------------------------------------------------------------------

class PluginAlignakGraphite extends CommonDBTM {

   /**
    * The right name for this class
    *
    * @var string
    */
   static $rightname = 'plugin_alignak_graphite';
   
   private $initGraphiteParams = false;
   private $templateId;

   const IP_ADDRESS_GRAPHITE = '192.168.1.27';
   const CONST_URL_GRAPHITE_QUERY = '/render?target=';
   const RAW_FORMAT_GRAPHITE = '&format=raw';
   const JSON_FORMAT_GRAPHITE = '&format=json';
   private $urlGraphiteQuery = '';
   
   
   static function getTypeName($nb = 0) {
      return _n('Graphite', 'Graphites', $nb, 'alignak');
   }

   /**
   * Read graphite counters
   *
   * @param $template_id integer ID of the template
   *
   *@return bool true if read is ok
   *
   **/
   function readCounters( $template_id) {
      global $DB,$CFG_GLPI;

      if( !$this->initGraphiteParams) {
         $this->initGraphiteParams = $this->initGraphite();
      }
      $this->templateId = $template_id;
      $ret = $this->searchMetrics();
      
      return $ret;
   }
   
   
   /**
   * Init graphite
   *
   *@return bool true if read is ok
   *
   **/   
   function initGraphite() {
      $this->urlGraphiteQuery = 'http://'.$this::IP_ADDRESS_GRAPHITE. $this::CONST_URL_GRAPHITE_QUERY;
      return true;
   }
   
   /**
   * searchMetrics
   *
   *@return bool true if read is ok
   *
   **/   
   function searchMetrics() {
      $counters = [];
      $counters = $this->getCountersFromTemplate();
      $computersName = $this->getComputersNameWithThatTemplate();
      
      foreach( $counters as $counter) {
         $counterGraphiteName = $counter['graphite_name'];
         foreach( $computersName as $computerName) {
            $counterValues = $this->requestValues( $counterGraphiteName, $computerName);
            $storedCounters = $this->storeCounters($counterGraphiteName, $computerName, $counterValues);
            echo "<BR>STORED: ".$storedCounters;
         }
      }
      return count($counters);
   }
   
   /**
   * getCountersFromTemplate
   *
   *@return array list of counters for the templateId
   *
   **/   
   function getCountersFromTemplate() {
      $countersTemplate = new PluginAlignakCountersTemplate();
      return $countersTemplate->getCounters( $this->templateId);
   }
   
   /**
   * getComputersNameWithThatTemplate
   *
   *@return array list of computers name for the templateId
   *
   **/   
   function getComputersNameWithThatTemplate() {
      $computerCountersTemplate = new PluginAlignakComputerCountersTemplate();
      return $computerCountersTemplate->getComputersName( $this->templateId);
   }
   
   /**
   * requestValues
   *
   * @param $counterName string Name of the counter to query
   * @param $computerName string Name of the computer to query
   *
   *@return array list of pairs (value, timestamp) for that counter and that computer
   *
   **/   
   function requestValues( $counterName, $computerName) {
      
// collectdunbuntucollectd.battery-0.capacity
//      $computerName = 'collectdunbuntucollectd';
//      $counterName   = 'battery-0.capacity';
      
      $queryGraphite = $this->urlGraphiteQuery.$computerName.".".$counterName.$this::JSON_FORMAT_GRAPHITE;
      
      echo '<br>QUERY to: '.$queryGraphite;
      $json = file_get_contents($queryGraphite);
      // $json = '[{"target": "collectdunbuntucollectd.battery-0.capacity", "datapoints": [[null, 1537680780], [null, 1537680840], [null, 1537680900], [null, 1537680960], [null, 1537681020], [null, 1537681080], [null, 1537681140], [null, 1537681200], [null, 1537681260], [null, 1537681320], [16.5, 1537681380], [16.5, 1537681440], [16.5, 1537681500], [16.0, 1537681560], [16.0, 1537681620], [16.0, 1537681680], [15.5, 1537681740], [15.5, 1537681800], [15.0, 1537681860], [15.0, 1537681920], [15.0, 1537681980], [14.5, 1537682040], [14.5, 1537682100], [14.5, 1537682160], [14.0, 1537682220], [14.0, 1537682280], [14.0, 1537682340], [13.5, 1537682400], [13.5, 1537682460], [13.5, 1537682520], [13.0, 1537682580], [13.0, 1537682640], [13.0, 1537682700], [12.5, 1537682760], [12.5, 1537682820], [12.5, 1537682880], [12.0, 1537682940], [12.0, 1537683000], [12.0, 1537683060], [11.5, 1537683120], [11.5, 1537683180], [11.0, 1537683240], [11.0, 1537683300], [11.0, 1537683360], [10.5, 1537683420], [10.5, 1537683480], [10.0, 1537683540], [10.0, 1537683600], [10.0, 1537683660], [9.5, 1537683720], [10.5, 1537683780], [11.0, 1537683840], [11.5, 1537683900], [12.5, 1537683960], [13.0, 1537684020], [14.0, 1537684080], [14.5, 1537684140], [15.0, 1537684200], [16.0, 1537684260], [16.5, 1537684320], [17.0, 1537684380], [18.0, 1537684440], [18.5, 1537684500], [19.5, 1537684560], [20.0, 1537684620], [20.5, 1537684680], [21.5, 1537684740], [22.0, 1537684800], [23.0, 1537684860], [23.5, 1537684920], [24.0, 1537684980], [25.0, 1537685040], [25.5, 1537685100], [26.0, 1537685160], [27.0, 1537685220], [27.5, 1537685280], [28.5, 1537685340], [29.0, 1537685400], [29.5, 1537685460], [30.5, 1537685520], [31.0, 1537685580], [32.0, 1537685640], [32.5, 1537685700], [33.0, 1537685760], [34.0, 1537685820], [34.5, 1537685880], [35.0, 1537685940], [36.0, 1537686000], [36.5, 1537686060], [37.0, 1537686120], [37.5, 1537686180], [38.5, 1537686240], [39.0, 1537686300], [39.5, 1537686360], [40.0, 1537686420], [40.5, 1537686480], [41.0, 1537686540], [41.0, 1537686600], [41.5, 1537686660], [42.0, 1537686720], [42.5, 1537686780], [43.0, 1537686840], [43.0, 1537686900], [43.5, 1537686960], [44.0, 1537687020], [44.0, 1537687080], [44.5, 1537687140], [44.5, 1537687200], [45.0, 1537687260], [45.0, 1537687320], [45.5, 1537687380], [45.5, 1537687440], [46.0, 1537687500], [46.0, 1537687560], [46.5, 1537687620], [46.5, 1537687680], [46.5, 1537687740], [47.0, 1537687800], [47.0, 1537687860], [47.0, 1537687920], [47.5, 1537687980], [47.5, 1537688040], [47.5, 1537688100], [48.0, 1537688160], [48.0, 1537688220], [48.0, 1537688280], [48.5, 1537688340], [48.5, 1537688400], [48.5, 1537688460], [48.5, 1537688520], [49.0, 1537688580], [49.0, 1537688640], [49.0, 1537688700], [49.0, 1537688760], [49.0, 1537688820], [49.5, 1537688880], [49.5, 1537688940], [49.5, 1537689000], [49.5, 1537689060], [49.5, 1537689120], [49.5, 1537689180], [49.5, 1537689240], [49.5, 1537689300], [49.5, 1537689360], [49.5, 1537689420], [49.5, 1537689480], [49.5, 1537689540], [49.5, 1537689600], [49.5, 1537689660], [49.5, 1537689720], [49.5, 1537689780], [49.5, 1537689840], [49.5, 1537689900], [49.5, 1537689960], [49.5, 1537690020], [49.5, 1537690080], [49.5, 1537690140], [49.5, 1537690200], [49.5, 1537690260], [49.5, 1537690320], [50.0, 1537690380], [50.0, 1537690440], [50.0, 1537690500], [50.0, 1537690560], [50.0, 1537690620], [50.0, 1537690680], [50.0, 1537690740], [50.0, 1537690800], [50.0, 1537690860], [50.0, 1537690920], [50.0, 1537690980], [50.0, 1537691040], [50.0, 1537691100], [50.0, 1537691160], [50.0, 1537691220], [50.0, 1537691280], [50.0, 1537691340], [50.0, 1537691400], [50.0, 1537691460], [50.0, 1537691520], [50.0, 1537691580], [50.0, 1537691640], [50.0, 1537691700], [50.0, 1537691760], [50.0, 1537691820], [50.0, 1537691880], [50.0, 1537691940], [50.0, 1537692000], [50.0, 1537692060], [50.0, 1537692120], [50.0, 1537692180], [50.0, 1537692240], [50.0, 1537692300], [50.0, 1537692360], [50.0, 1537692420], [50.0, 1537692480], [50.0, 1537692540], [50.0, 1537692600], [50.0, 1537692660], [50.0, 1537692720], [50.0, 1537692780], [50.0, 1537692840], [50.0, 1537692900], [50.0, 1537692960], [50.0, 1537693020], [50.0, 1537693080], [50.0, 1537693140], [50.0, 1537693200], [50.0, 1537693260], [50.0, 1537693320], [50.0, 1537693380], [50.0, 1537693440], [50.0, 1537693500], [50.0, 1537693560], [50.0, 1537693620], [50.0, 1537693680], [50.0, 1537693740], [50.0, 1537693800], [50.0, 1537693860], [50.0, 1537693920], [50.0, 1537693980], [50.0, 1537694040], [50.0, 1537694100], [50.0, 1537694160], [50.0, 1537694220], [50.0, 1537694280], [50.0, 1537694340], [50.0, 1537694400], [50.0, 1537694460], [50.0, 1537694520], [50.0, 1537694580], [50.0, 1537694640], [50.0, 1537694700], [50.0, 1537694760], [50.0, 1537694820], [50.0, 1537694880], [50.0, 1537694940], [50.0, 1537695000], [50.0, 1537695060], [50.0, 1537695120], [50.0, 1537695180], [50.0, 1537695240], [50.0, 1537695300], [50.0, 1537695360], [50.0, 1537695420], [50.0, 1537695480], [50.0, 1537695540], [50.0, 1537695600], [50.0, 1537695660], [50.0, 1537695720], [50.0, 1537695780], [50.0, 1537695840], [50.0, 1537695900], [50.0, 1537695960], [50.0, 1537696020], [50.0, 1537696080], [50.0, 1537696140], [50.0, 1537696200], [50.0, 1537696260], [50.0, 1537696320], [50.0, 1537696380], [50.0, 1537696440], [50.0, 1537696500], [50.0, 1537696560], [50.0, 1537696620], [50.0, 1537696680], [50.0, 1537696740], [50.0, 1537696800], [50.0, 1537696860], [50.0, 1537696920], [50.0, 1537696980], [50.0, 1537697040], [50.0, 1537697100], [50.0, 1537697160], [50.0, 1537697220], [50.0, 1537697280], [50.0, 1537697340], [50.0, 1537697400], [50.0, 1537697460], [50.0, 1537697520], [50.0, 1537697580], [50.0, 1537697640], [50.0, 1537697700], [50.0, 1537697760], [50.0, 1537697820], [50.0, 1537697880], [50.0, 1537697940], [50.0, 1537698000], [50.0, 1537698060], [50.0, 1537698120], [50.0, 1537698180], [50.0, 1537698240], [50.0, 1537698300], [50.0, 1537698360], [50.0, 1537698420], [50.0, 1537698480], [50.0, 1537698540], [50.0, 1537698600], [50.0, 1537698660], [50.0, 1537698720], [50.0, 1537698780], [50.0, 1537698840], [50.0, 1537698900], [50.0, 1537698960], [50.0, 1537699020], [50.0, 1537699080], [50.0, 1537699140], [50.0, 1537699200], [50.0, 1537699260], [50.0, 1537699320], [50.0, 1537699380], [50.0, 1537699440], [50.0, 1537699500], [50.0, 1537699560], [50.0, 1537699620], [50.0, 1537699680], [50.0, 1537699740], [50.0, 1537699800], [50.0, 1537699860], [50.0, 1537699920], [50.0, 1537699980], [50.0, 1537700040], [50.0, 1537700100], [50.0, 1537700160], [50.0, 1537700220], [50.0, 1537700280], [50.0, 1537700340], [50.0, 1537700400], [50.0, 1537700460], [50.0, 1537700520], [50.0, 1537700580], [50.0, 1537700640], [50.0, 1537700700], [50.0, 1537700760], [50.0, 1537700820], [50.0, 1537700880], [50.0, 1537700940], [50.0, 1537701000], [50.0, 1537701060], [50.0, 1537701120], [50.0, 1537701180], [50.0, 1537701240], [50.0, 1537701300], [50.0, 1537701360], [50.0, 1537701420], [50.0, 1537701480], [50.0, 1537701540], [50.0, 1537701600], [50.0, 1537701660], [50.0, 1537701720], [50.0, 1537701780], [50.0, 1537701840], [50.0, 1537701900], [50.0, 1537701960], [50.0, 1537702020], [50.0, 1537702080], [50.0, 1537702140], [50.0, 1537702200], [50.0, 1537702260], [50.0, 1537702320], [50.0, 1537702380], [50.0, 1537702440], [50.0, 1537702500], [50.0, 1537702560], [50.0, 1537702620], [50.0, 1537702680], [50.0, 1537702740], [50.0, 1537702800], [50.0, 1537702860], [50.0, 1537702920], [50.0, 1537702980], [50.0, 1537703040], [50.0, 1537703100], [50.0, 1537703160], [50.0, 1537703220], [50.0, 1537703280], [50.0, 1537703340], [50.0, 1537703400], [50.0, 1537703460], [50.0, 1537703520], [50.0, 1537703580], [50.0, 1537703640], [50.0, 1537703700], [50.0, 1537703760], [50.0, 1537703820], [50.0, 1537703880], [50.0, 1537703940], [50.0, 1537704000], [50.0, 1537704060], [50.0, 1537704120], [50.0, 1537704180], [50.0, 1537704240], [50.0, 1537704300], [50.0, 1537704360], [50.0, 1537704420], [50.0, 1537704480], [50.0, 1537704540], [50.0, 1537704600], [50.0, 1537704660], [50.0, 1537704720], [50.0, 1537704780], [50.0, 1537704840], [50.0, 1537704900], [50.0, 1537704960], [50.0, 1537705020], [50.0, 1537705080], [50.0, 1537705140], [50.0, 1537705200], [50.0, 1537705260], [50.0, 1537705320], [50.0, 1537705380], [50.0, 1537705440], [50.0, 1537705500], [50.0, 1537705560], [50.0, 1537705620], [50.0, 1537705680], [50.0, 1537705740], [50.0, 1537705800], [50.0, 1537705860], [50.0, 1537705920], [50.0, 1537705980], [50.0, 1537706040], [50.0, 1537706100], [50.0, 1537706160], [50.0, 1537706220], [50.0, 1537706280], [50.0, 1537706340], [50.0, 1537706400], [50.0, 1537706460], [50.0, 1537706520], [50.0, 1537706580], [50.0, 1537706640], [50.0, 1537706700], [50.0, 1537706760], [50.0, 1537706820], [50.0, 1537706880], [50.0, 1537706940], [50.0, 1537707000], [50.0, 1537707060], [50.0, 1537707120], [50.0, 1537707180], [50.0, 1537707240], [50.0, 1537707300], [50.0, 1537707360], [50.0, 1537707420], [50.0, 1537707480], [50.0, 1537707540], [50.0, 1537707600], [50.0, 1537707660], [50.0, 1537707720], [50.0, 1537707780], [50.0, 1537707840], [50.0, 1537707900], [50.0, 1537707960], [50.0, 1537708020], [50.0, 1537708080], [50.0, 1537708140], [50.0, 1537708200], [50.0, 1537708260], [50.0, 1537708320], [50.0, 1537708380], [50.0, 1537708440], [50.0, 1537708500], [50.0, 1537708560], [50.0, 1537708620], [50.0, 1537708680], [50.0, 1537708740], [50.0, 1537708800], [50.0, 1537708860], [50.0, 1537708920], [50.0, 1537708980], [50.0, 1537709040], [50.0, 1537709100], [50.0, 1537709160], [50.0, 1537709220], [50.0, 1537709280], [50.0, 1537709340], [50.0, 1537709400], [50.0, 1537709460], [50.0, 1537709520], [50.0, 1537709580], [50.0, 1537709640], [50.0, 1537709700], [50.0, 1537709760], [50.0, 1537709820], [50.0, 1537709880], [50.0, 1537709940], [50.0, 1537710000], [50.0, 1537710060], [50.0, 1537710120], [50.0, 1537710180], [50.0, 1537710240], [50.0, 1537710300], [50.0, 1537710360], [50.0, 1537710420], [50.0, 1537710480], [50.0, 1537710540], [50.0, 1537710600], [50.0, 1537710660], [50.0, 1537710720], [50.0, 1537710780], [50.0, 1537710840], [50.0, 1537710900], [50.0, 1537710960], [50.0, 1537711020], [50.0, 1537711080], [50.0, 1537711140], [50.0, 1537711200], [50.0, 1537711260], [50.0, 1537711320], [50.0, 1537711380], [50.0, 1537711440], [50.0, 1537711500], [50.0, 1537711560], [50.0, 1537711620], [50.0, 1537711680], [50.0, 1537711740], [50.0, 1537711800], [50.0, 1537711860], [50.0, 1537711920], [50.0, 1537711980], [50.0, 1537712040], [50.0, 1537712100], [50.0, 1537712160], [50.0, 1537712220], [50.0, 1537712280], [50.0, 1537712340], [50.0, 1537712400], [50.0, 1537712460], [50.0, 1537712520], [50.0, 1537712580], [50.0, 1537712640], [50.0, 1537712700], [50.0, 1537712760], [50.0, 1537712820], [50.0, 1537712880], [50.0, 1537712940], [50.0, 1537713000], [50.0, 1537713060], [50.0, 1537713120], [50.0, 1537713180], [50.0, 1537713240], [50.0, 1537713300], [50.0, 1537713360], [50.0, 1537713420], [50.0, 1537713480], [50.0, 1537713540], [50.0, 1537713600], [50.0, 1537713660], [50.0, 1537713720], [50.0, 1537713780], [50.0, 1537713840], [50.0, 1537713900], [50.0, 1537713960], [50.0, 1537714020], [50.0, 1537714080], [50.0, 1537714140], [50.0, 1537714200], [50.0, 1537714260], [50.0, 1537714320], [50.0, 1537714380], [50.0, 1537714440], [50.0, 1537714500], [50.0, 1537714560], [50.0, 1537714620], [50.0, 1537714680], [50.0, 1537714740], [50.0, 1537714800], [50.0, 1537714860], [50.0, 1537714920], [50.0, 1537714980], [50.0, 1537715040], [50.0, 1537715100], [50.0, 1537715160], [50.0, 1537715220], [50.0, 1537715280], [50.0, 1537715340], [50.0, 1537715400], [50.0, 1537715460], [50.0, 1537715520], [50.0, 1537715580], [50.0, 1537715640], [50.0, 1537715700], [50.0, 1537715760], [50.0, 1537715820], [50.0, 1537715880], [50.0, 1537715940], [50.0, 1537716000], [50.0, 1537716060], [50.0, 1537716120], [50.0, 1537716180], [50.0, 1537716240], [50.0, 1537716300], [50.0, 1537716360], [50.0, 1537716420], [50.0, 1537716480], [50.0, 1537716540], [50.0, 1537716600], [50.0, 1537716660], [50.0, 1537716720], [50.0, 1537716780], [50.0, 1537716840], [50.0, 1537716900], [50.0, 1537716960], [50.0, 1537717020], [50.0, 1537717080], [50.0, 1537717140], [50.0, 1537717200], [50.0, 1537717260], [50.0, 1537717320], [50.0, 1537717380], [50.0, 1537717440], [50.0, 1537717500], [50.0, 1537717560], [50.0, 1537717620], [50.0, 1537717680], [50.0, 1537717740], [50.0, 1537717800], [50.0, 1537717860], [50.0, 1537717920], [50.0, 1537717980], [50.0, 1537718040], [50.0, 1537718100], [50.0, 1537718160], [50.0, 1537718220], [50.0, 1537718280], [50.0, 1537718340], [50.0, 1537718400], [50.0, 1537718460], [50.0, 1537718520], [50.0, 1537718580], [50.0, 1537718640], [50.0, 1537718700], [50.0, 1537718760], [50.0, 1537718820], [50.0, 1537718880], [50.0, 1537718940], [50.0, 1537719000], [50.0, 1537719060], [50.0, 1537719120], [50.0, 1537719180], [50.0, 1537719240], [50.0, 1537719300], [50.0, 1537719360], [50.0, 1537719420], [50.0, 1537719480], [50.0, 1537719540], [50.0, 1537719600], [50.0, 1537719660], [50.0, 1537719720], [50.0, 1537719780], [50.0, 1537719840], [50.0, 1537719900], [50.0, 1537719960], [50.0, 1537720020], [50.0, 1537720080], [50.0, 1537720140], [50.0, 1537720200], [50.0, 1537720260], [50.0, 1537720320], [50.0, 1537720380], [50.0, 1537720440], [50.0, 1537720500], [50.0, 1537720560], [50.0, 1537720620], [50.0, 1537720680], [50.0, 1537720740], [50.0, 1537720800], [50.0, 1537720860], [50.0, 1537720920], [50.0, 1537720980], [50.0, 1537721040], [50.0, 1537721100], [50.0, 1537721160], [50.0, 1537721220], [50.0, 1537721280], [50.0, 1537721340], [50.0, 1537721400], [50.0, 1537721460], [50.0, 1537721520], [50.0, 1537721580], [50.0, 1537721640], [50.0, 1537721700], [50.0, 1537721760], [50.0, 1537721820], [50.0, 1537721880], [50.0, 1537721940], [50.0, 1537722000], [50.0, 1537722060], [50.0, 1537722120], [50.0, 1537722180], [50.0, 1537722240], [50.0, 1537722300], [50.0, 1537722360], [50.0, 1537722420], [50.0, 1537722480], [50.0, 1537722540], [50.0, 1537722600], [50.0, 1537722660], [50.0, 1537722720], [50.0, 1537722780], [50.0, 1537722840], [50.0, 1537722900], [50.0, 1537722960], [50.0, 1537723020], [50.0, 1537723080], [50.0, 1537723140], [50.0, 1537723200], [50.0, 1537723260], [50.0, 1537723320], [50.0, 1537723380], [50.0, 1537723440], [50.0, 1537723500], [50.0, 1537723560], [50.0, 1537723620], [50.0, 1537723680], [50.0, 1537723740], [50.0, 1537723800], [50.0, 1537723860], [50.0, 1537723920], [50.0, 1537723980], [50.0, 1537724040], [50.0, 1537724100], [50.0, 1537724160], [50.0, 1537724220], [50.0, 1537724280], [50.0, 1537724340], [50.0, 1537724400], [50.0, 1537724460], [50.0, 1537724520], [50.0, 1537724580], [50.0, 1537724640], [50.0, 1537724700], [50.0, 1537724760], [50.0, 1537724820], [50.0, 1537724880], [50.0, 1537724940], [50.0, 1537725000], [50.0, 1537725060], [50.0, 1537725120], [50.0, 1537725180], [50.0, 1537725240], [50.0, 1537725300], [50.0, 1537725360], [50.0, 1537725420], [50.0, 1537725480], [50.0, 1537725540], [50.0, 1537725600], [50.0, 1537725660], [50.0, 1537725720], [50.0, 1537725780], [50.0, 1537725840], [50.0, 1537725900], [50.0, 1537725960], [50.0, 1537726020], [50.0, 1537726080], [50.0, 1537726140], [50.0, 1537726200], [50.0, 1537726260], [50.0, 1537726320], [50.0, 1537726380], [50.0, 1537726440], [50.0, 1537726500], [50.0, 1537726560], [50.0, 1537726620], [50.0, 1537726680], [50.0, 1537726740], [50.0, 1537726800], [50.0, 1537726860], [50.0, 1537726920], [50.0, 1537726980], [50.0, 1537727040], [50.0, 1537727100], [50.0, 1537727160], [50.0, 1537727220], [50.0, 1537727280], [50.0, 1537727340], [50.0, 1537727400], [50.0, 1537727460], [50.0, 1537727520], [50.0, 1537727580], [50.0, 1537727640], [50.0, 1537727700], [50.0, 1537727760], [50.0, 1537727820], [50.0, 1537727880], [50.0, 1537727940], [50.0, 1537728000], [50.0, 1537728060], [50.0, 1537728120], [50.0, 1537728180], [50.0, 1537728240], [50.0, 1537728300], [50.0, 1537728360], [50.0, 1537728420], [50.0, 1537728480], [50.0, 1537728540], [50.0, 1537728600], [50.0, 1537728660], [50.0, 1537728720], [50.0, 1537728780], [50.0, 1537728840], [50.0, 1537728900], [50.0, 1537728960], [50.0, 1537729020], [50.0, 1537729080], [50.0, 1537729140], [50.0, 1537729200], [50.0, 1537729260], [50.0, 1537729320], [50.0, 1537729380], [50.0, 1537729440], [50.0, 1537729500], [50.0, 1537729560], [50.0, 1537729620], [50.0, 1537729680], [50.0, 1537729740], [50.0, 1537729800], [50.0, 1537729860], [50.0, 1537729920], [50.0, 1537729980], [50.0, 1537730040], [50.0, 1537730100], [50.0, 1537730160], [50.0, 1537730220], [50.0, 1537730280], [50.0, 1537730340], [50.0, 1537730400], [50.0, 1537730460], [50.0, 1537730520], [50.0, 1537730580], [50.0, 1537730640], [50.0, 1537730700], [50.0, 1537730760], [50.0, 1537730820], [50.0, 1537730880], [50.0, 1537730940], [50.0, 1537731000], [50.0, 1537731060], [50.0, 1537731120], [50.0, 1537731180], [50.0, 1537731240], [50.0, 1537731300], [50.0, 1537731360], [50.0, 1537731420], [50.0, 1537731480], [50.0, 1537731540], [50.0, 1537731600], [50.0, 1537731660], [50.0, 1537731720], [50.0, 1537731780], [50.0, 1537731840], [50.0, 1537731900], [50.0, 1537731960], [50.0, 1537732020], [50.0, 1537732080], [50.0, 1537732140], [50.0, 1537732200], [50.0, 1537732260], [50.0, 1537732320], [50.0, 1537732380], [50.0, 1537732440], [50.0, 1537732500], [50.0, 1537732560], [50.0, 1537732620], [50.0, 1537732680], [50.0, 1537732740], [50.0, 1537732800], [50.0, 1537732860], [50.0, 1537732920], [50.0, 1537732980], [50.0, 1537733040], [50.0, 1537733100], [50.0, 1537733160], [50.0, 1537733220], [50.0, 1537733280], [50.0, 1537733340], [50.0, 1537733400], [50.0, 1537733460], [50.0, 1537733520], [50.0, 1537733580], [50.0, 1537733640], [50.0, 1537733700], [50.0, 1537733760], [50.0, 1537733820], [50.0, 1537733880], [50.0, 1537733940], [50.0, 1537734000], [50.0, 1537734060], [50.0, 1537734120], [50.0, 1537734180], [50.0, 1537734240], [50.0, 1537734300], [50.0, 1537734360], [50.0, 1537734420], [50.0, 1537734480], [50.0, 1537734540], [50.0, 1537734600], [50.0, 1537734660], [50.0, 1537734720], [50.0, 1537734780], [50.0, 1537734840], [50.0, 1537734900], [50.0, 1537734960], [50.0, 1537735020], [50.0, 1537735080], [50.0, 1537735140], [50.0, 1537735200], [50.0, 1537735260], [50.0, 1537735320], [50.0, 1537735380], [50.0, 1537735440], [50.0, 1537735500], [50.0, 1537735560], [50.0, 1537735620], [50.0, 1537735680], [50.0, 1537735740], [50.0, 1537735800], [50.0, 1537735860], [50.0, 1537735920], [50.0, 1537735980], [50.0, 1537736040], [50.0, 1537736100], [50.0, 1537736160], [50.0, 1537736220], [50.0, 1537736280], [50.0, 1537736340], [50.0, 1537736400], [50.0, 1537736460], [50.0, 1537736520], [50.0, 1537736580], [50.0, 1537736640], [50.0, 1537736700], [50.0, 1537736760], [50.0, 1537736820], [50.0, 1537736880], [50.0, 1537736940], [50.0, 1537737000], [50.0, 1537737060], [50.0, 1537737120], [50.0, 1537737180], [50.0, 1537737240], [50.0, 1537737300], [50.0, 1537737360], [50.0, 1537737420], [50.0, 1537737480], [50.0, 1537737540], [50.0, 1537737600], [50.0, 1537737660], [50.0, 1537737720], [50.0, 1537737780], [50.0, 1537737840], [50.0, 1537737900], [50.0, 1537737960], [50.0, 1537738020], [50.0, 1537738080], [50.0, 1537738140], [50.0, 1537738200], [50.0, 1537738260], [50.0, 1537738320], [50.0, 1537738380], [50.0, 1537738440], [50.0, 1537738500], [50.0, 1537738560], [50.0, 1537738620], [50.0, 1537738680], [50.0, 1537738740], [50.0, 1537738800], [50.0, 1537738860], [50.0, 1537738920], [50.0, 1537738980], [50.0, 1537739040], [50.0, 1537739100], [50.0, 1537739160], [50.0, 1537739220], [50.0, 1537739280], [50.0, 1537739340], [50.0, 1537739400], [50.0, 1537739460], [50.0, 1537739520], [50.0, 1537739580], [50.0, 1537739640], [50.0, 1537739700], [50.0, 1537739760], [50.0, 1537739820], [50.0, 1537739880], [50.0, 1537739940], [50.0, 1537740000], [50.0, 1537740060], [50.0, 1537740120], [50.0, 1537740180], [50.0, 1537740240], [50.0, 1537740300], [50.0, 1537740360], [50.0, 1537740420], [50.0, 1537740480], [50.0, 1537740540], [50.0, 1537740600], [50.0, 1537740660], [50.0, 1537740720], [50.0, 1537740780], [50.0, 1537740840], [50.0, 1537740900], [50.0, 1537740960], [50.0, 1537741020], [50.0, 1537741080], [50.0, 1537741140], [50.0, 1537741200], [50.0, 1537741260], [50.0, 1537741320], [50.0, 1537741380], [50.0, 1537741440], [50.0, 1537741500], [50.0, 1537741560], [50.0, 1537741620], [50.0, 1537741680], [50.0, 1537741740], [50.0, 1537741800], [50.0, 1537741860], [50.0, 1537741920], [50.0, 1537741980], [50.0, 1537742040], [50.0, 1537742100], [50.0, 1537742160], [50.0, 1537742220], [50.0, 1537742280], [50.0, 1537742340], [50.0, 1537742400], [50.0, 1537742460], [50.0, 1537742520], [50.0, 1537742580], [50.0, 1537742640], [50.0, 1537742700], [50.0, 1537742760], [50.0, 1537742820], [50.0, 1537742880], [50.0, 1537742940], [50.0, 1537743000], [50.0, 1537743060], [50.0, 1537743120], [50.0, 1537743180], [50.0, 1537743240], [50.0, 1537743300], [50.0, 1537743360], [50.0, 1537743420], [50.0, 1537743480], [50.0, 1537743540], [50.0, 1537743600], [50.0, 1537743660], [50.0, 1537743720], [50.0, 1537743780], [50.0, 1537743840], [50.0, 1537743900], [50.0, 1537743960], [50.0, 1537744020], [50.0, 1537744080], [50.0, 1537744140], [50.0, 1537744200], [50.0, 1537744260], [50.0, 1537744320], [50.0, 1537744380], [50.0, 1537744440], [50.0, 1537744500], [50.0, 1537744560], [50.0, 1537744620], [50.0, 1537744680], [50.0, 1537744740], [50.0, 1537744800], [50.0, 1537744860], [50.0, 1537744920], [50.0, 1537744980], [50.0, 1537745040], [50.0, 1537745100], [50.0, 1537745160], [50.0, 1537745220], [50.0, 1537745280], [50.0, 1537745340], [50.0, 1537745400], [50.0, 1537745460], [50.0, 1537745520], [50.0, 1537745580], [50.0, 1537745640], [50.0, 1537745700], [50.0, 1537745760], [50.0, 1537745820], [50.0, 1537745880], [50.0, 1537745940], [50.0, 1537746000], [50.0, 1537746060], [50.0, 1537746120], [50.0, 1537746180], [50.0, 1537746240], [50.0, 1537746300], [50.0, 1537746360], [50.0, 1537746420], [50.0, 1537746480], [50.0, 1537746540], [50.0, 1537746600], [50.0, 1537746660], [50.0, 1537746720], [50.0, 1537746780], [50.0, 1537746840], [50.0, 1537746900], [50.0, 1537746960], [50.0, 1537747020], [50.0, 1537747080], [50.0, 1537747140], [50.0, 1537747200], [50.0, 1537747260], [50.0, 1537747320], [50.0, 1537747380], [50.0, 1537747440], [50.0, 1537747500], [50.0, 1537747560], [50.0, 1537747620], [50.0, 1537747680], [50.0, 1537747740], [50.0, 1537747800], [50.0, 1537747860], [50.0, 1537747920], [50.0, 1537747980], [50.0, 1537748040], [50.0, 1537748100], [50.0, 1537748160], [50.0, 1537748220], [50.0, 1537748280], [50.0, 1537748340], [50.0, 1537748400], [50.0, 1537748460], [50.0, 1537748520], [50.0, 1537748580], [50.0, 1537748640], [50.0, 1537748700], [50.0, 1537748760], [50.0, 1537748820], [50.0, 1537748880], [50.0, 1537748940], [50.0, 1537749000], [50.0, 1537749060], [50.0, 1537749120], [50.0, 1537749180], [50.0, 1537749240], [50.0, 1537749300], [50.0, 1537749360], [50.0, 1537749420], [50.0, 1537749480], [50.0, 1537749540], [50.0, 1537749600], [50.0, 1537749660], [50.0, 1537749720], [50.0, 1537749780], [50.0, 1537749840], [50.0, 1537749900], [50.0, 1537749960], [50.0, 1537750020], [50.0, 1537750080], [50.0, 1537750140], [50.0, 1537750200], [50.0, 1537750260], [50.0, 1537750320], [50.0, 1537750380], [50.0, 1537750440], [50.0, 1537750500], [50.0, 1537750560], [50.0, 1537750620], [50.0, 1537750680], [50.0, 1537750740], [50.0, 1537750800], [50.0, 1537750860], [50.0, 1537750920], [50.0, 1537750980], [50.0, 1537751040], [50.0, 1537751100], [50.0, 1537751160], [50.0, 1537751220], [50.0, 1537751280], [50.0, 1537751340], [50.0, 1537751400], [50.0, 1537751460], [50.0, 1537751520], [50.0, 1537751580], [50.0, 1537751640], [50.0, 1537751700], [50.0, 1537751760], [50.0, 1537751820], [50.0, 1537751880], [50.0, 1537751940], [50.0, 1537752000], [50.0, 1537752060], [50.0, 1537752120], [50.0, 1537752180], [50.0, 1537752240], [50.0, 1537752300], [50.0, 1537752360], [50.0, 1537752420], [50.0, 1537752480], [50.0, 1537752540], [50.0, 1537752600], [50.0, 1537752660], [50.0, 1537752720], [50.0, 1537752780], [50.0, 1537752840], [50.0, 1537752900], [50.0, 1537752960], [50.0, 1537753020], [50.0, 1537753080], [50.0, 1537753140], [50.0, 1537753200], [50.0, 1537753260], [50.0, 1537753320], [50.0, 1537753380], [50.0, 1537753440], [50.0, 1537753500], [50.0, 1537753560], [50.0, 1537753620], [50.0, 1537753680], [50.0, 1537753740], [50.0, 1537753800], [50.0, 1537753860], [50.0, 1537753920], [50.0, 1537753980], [50.0, 1537754040], [50.0, 1537754100], [50.0, 1537754160], [50.0, 1537754220], [50.0, 1537754280], [50.0, 1537754340], [50.0, 1537754400], [50.0, 1537754460], [50.0, 1537754520], [50.0, 1537754580], [50.0, 1537754640], [50.0, 1537754700], [50.0, 1537754760], [50.0, 1537754820], [50.0, 1537754880], [50.0, 1537754940], [50.0, 1537755000], [50.0, 1537755060], [50.0, 1537755120], [50.0, 1537755180], [50.0, 1537755240], [50.0, 1537755300], [50.0, 1537755360], [50.0, 1537755420], [50.0, 1537755480], [50.0, 1537755540], [50.0, 1537755600], [50.0, 1537755660], [50.0, 1537755720], [50.0, 1537755780], [50.0, 1537755840], [50.0, 1537755900], [50.0, 1537755960], [50.0, 1537756020], [50.0, 1537756080], [50.0, 1537756140], [50.0, 1537756200], [50.0, 1537756260], [50.0, 1537756320], [50.0, 1537756380], [50.0, 1537756440], [50.0, 1537756500], [50.0, 1537756560], [50.0, 1537756620], [50.0, 1537756680], [50.0, 1537756740], [50.0, 1537756800], [50.0, 1537756860], [50.0, 1537756920], [50.0, 1537756980], [50.0, 1537757040], [50.0, 1537757100], [50.0, 1537757160], [50.0, 1537757220], [50.0, 1537757280], [50.0, 1537757340], [50.0, 1537757400], [50.0, 1537757460], [50.0, 1537757520], [50.0, 1537757580], [50.0, 1537757640], [50.0, 1537757700], [50.0, 1537757760], [50.0, 1537757820], [50.0, 1537757880], [50.0, 1537757940], [50.0, 1537758000], [50.0, 1537758060], [50.0, 1537758120], [50.0, 1537758180], [50.0, 1537758240], [50.0, 1537758300], [50.0, 1537758360], [50.0, 1537758420], [50.0, 1537758480], [50.0, 1537758540], [50.0, 1537758600], [50.0, 1537758660], [50.0, 1537758720], [50.0, 1537758780], [50.0, 1537758840], [50.0, 1537758900], [50.0, 1537758960], [50.0, 1537759020], [50.0, 1537759080], [50.0, 1537759140], [50.0, 1537759200], [50.0, 1537759260], [50.0, 1537759320], [50.0, 1537759380], [50.0, 1537759440], [50.0, 1537759500], [50.0, 1537759560], [50.0, 1537759620], [50.0, 1537759680], [50.0, 1537759740], [50.0, 1537759800], [50.0, 1537759860], [50.0, 1537759920], [50.0, 1537759980], [50.0, 1537760040], [50.0, 1537760100], [50.0, 1537760160], [50.0, 1537760220], [50.0, 1537760280], [50.0, 1537760340], [50.0, 1537760400], [50.0, 1537760460], [50.0, 1537760520], [50.0, 1537760580], [50.0, 1537760640], [50.0, 1537760700], [50.0, 1537760760], [50.0, 1537760820], [50.0, 1537760880], [50.0, 1537760940], [50.0, 1537761000], [50.0, 1537761060], [50.0, 1537761120], [50.0, 1537761180], [50.0, 1537761240], [50.0, 1537761300], [50.0, 1537761360], [50.0, 1537761420], [50.0, 1537761480], [50.0, 1537761540], [50.0, 1537761600], [50.0, 1537761660], [50.0, 1537761720], [50.0, 1537761780], [50.0, 1537761840], [50.0, 1537761900], [50.0, 1537761960], [50.0, 1537762020], [50.0, 1537762080], [50.0, 1537762140], [50.0, 1537762200], [50.0, 1537762260], [50.0, 1537762320], [50.0, 1537762380], [50.0, 1537762440], [50.0, 1537762500], [50.0, 1537762560], [50.0, 1537762620], [50.0, 1537762680], [50.0, 1537762740], [50.0, 1537762800], [50.0, 1537762860], [50.0, 1537762920], [50.0, 1537762980], [50.0, 1537763040], [50.0, 1537763100], [50.0, 1537763160], [50.0, 1537763220], [50.0, 1537763280], [50.0, 1537763340], [50.0, 1537763400], [50.0, 1537763460], [50.0, 1537763520], [50.0, 1537763580], [50.0, 1537763640], [50.0, 1537763700], [50.0, 1537763760], [50.0, 1537763820], [50.0, 1537763880], [50.0, 1537763940], [50.0, 1537764000], [50.0, 1537764060], [50.0, 1537764120], [50.0, 1537764180], [50.0, 1537764240], [50.0, 1537764300], [50.0, 1537764360], [50.0, 1537764420], [50.0, 1537764480], [50.0, 1537764540], [50.0, 1537764600], [50.0, 1537764660], [50.0, 1537764720], [50.0, 1537764780], [50.0, 1537764840], [50.0, 1537764900], [50.0, 1537764960], [50.0, 1537765020], [50.0, 1537765080], [50.0, 1537765140], [50.0, 1537765200], [49.5, 1537765260], [49.5, 1537765320], [49.5, 1537765380], [49.5, 1537765440], [49.5, 1537765500], [49.5, 1537765560], [49.5, 1537765620], [49.5, 1537765680], [49.5, 1537765740], [49.5, 1537765800], [49.5, 1537765860], [49.5, 1537765920], [49.5, 1537765980], [49.5, 1537766040], [49.5, 1537766100], [49.5, 1537766160], [49.5, 1537766220], [49.5, 1537766280], [49.5, 1537766340], [49.5, 1537766400], [49.5, 1537766460], [49.5, 1537766520], [49.5, 1537766580], [49.5, 1537766640], [49.5, 1537766700], [49.5, 1537766760], [49.5, 1537766820], [49.5, 1537766880], [49.5, 1537766940], [49.5, 1537767000], [49.5, 1537767060], [49.5, 1537767120]]}]';
      
      $arr = json_decode($json, true);
      foreach ($arr as $k=>$v){
         foreach( $v as $p=>$datapoints){
            if( is_array($datapoints)) {
               return $datapoints;
            }
         }
      }
      return null;
   }
   
   /**
   * storeCounters store the counter for a computer in database
   *
   * @param $counterName string Name of the counter to query
   * @param $computerName string Name of the computer to query
   * @param $counterValues array of pairs (value, timestamp) for that counter
   *
   *@return array list of computers for the templateId
   *
   **/   
   function storeCounters($counterGraphiteName, $computerName, $counterValues){
      global $DB;
      
      $table = "glpi_plugin_alignak_graphite_".$counterGraphiteName;
      if (!$DB->tableExists($table)) {
      /*   $queryDrop ="DROP TABLE  `".$table."` ";
         $result=$DB->query($queryDrop); */
         // table doesnt exist.: 
      // todo: move creation in counter creation
         $queryCreate ="CREATE TABLE IF NOT EXISTS `".$table."` (
         `computer_name` varchar(25) NOT NULL,
         `value` float NOT NULL,
         `timestamp` BIGINT NOT NULL
         )";
         $result=$DB->query($queryCreate);
         if( !$result) return $result;
         $queryAlter ="ALTER TABLE `".$table."` ADD INDEX( `computer_name`)";
         $result=$DB->query($queryAlter);
         $queryAlter ="ALTER TABLE `".$table."` ADD UNIQUE( `computer_name`, `timestamp`)";
         $result=$DB->query($queryAlter);
         if( !$result) return $result;
      }
      /*
            foreach($counterValues as $datapoint){
               $value      = $datapoint[0];
               $timestamp  = $datapoint[1];
               echo "<br>Value:".$value." time:".$timestamp;
            }*/
      $resultStore = 0;
      foreach($counterValues as $counter){
         $counterValue     = $counter[0];
         $counterTimestamp = $counter[1];
         
         $queryInsert = "INSERT into `".$table."` (`computer_name`, `value`, `timestamp`) VALUES ('".$computerName."','".$counterValue."',".$counterTimestamp.")";
       //  echo '<br>QUERY INSERT : '.$queryInsert;
         $result=$DB->query($queryInsert);
        // echo "<br>Resu:".$result.":".$resultStore;
         $resultStore += $result;
         PluginAlignakToolbox::log("StoreC: ". $result.":".$queryInsert);
      }
      return $resultStore;
   }
}

